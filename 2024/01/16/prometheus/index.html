<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"swordhell.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":{"gitalk":{"order":-2}},"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="概述Prometheus：负责采集和存储监控数据，支持多维度查询和告警规则。 Grafana：提供数据可视化和仪表板功能，与多种数据源集成，用于创建自定义监控视图。 Alertmanager：处理来自 Prometheus 的告警通知，执行用户定义的操作，帮助及时响应和解决异常情况。">
<meta property="og:type" content="article">
<meta property="og:title" content="prometheus">
<meta property="og:url" content="https://swordhell.github.io/2024/01/16/prometheus/index.html">
<meta property="og:site_name" content="Abel&#39;Blog">
<meta property="og:description" content="概述Prometheus：负责采集和存储监控数据，支持多维度查询和告警规则。 Grafana：提供数据可视化和仪表板功能，与多种数据源集成，用于创建自定义监控视图。 Alertmanager：处理来自 Prometheus 的告警通知，执行用户定义的操作，帮助及时响应和解决异常情况。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://swordhell.github.io/2024/01/16/prometheus/prometheus-alerts.jpg">
<meta property="og:image" content="https://swordhell.github.io/2024/01/16/prometheus/alertmanager.jpg">
<meta property="og:image" content="https://swordhell.github.io/2024/01/16/prometheus/blackbox_exporter.jpg">
<meta property="og:image" content="https://swordhell.github.io/2024/01/16/prometheus/prometheus-spring-boot.jpg">
<meta property="og:image" content="https://swordhell.github.io/2024/01/16/prometheus/prometheus-vrsion.jpg">
<meta property="article:published_time" content="2024-01-15T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-28T00:17:22.659Z">
<meta property="article:author" content="Abel Sean">
<meta property="article:tag" content="运维">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://swordhell.github.io/2024/01/16/prometheus/prometheus-alerts.jpg">

<link rel="canonical" href="https://swordhell.github.io/2024/01/16/prometheus/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>prometheus | Abel'Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Abel'Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">我干了什么?究竟拿了时间换了什么?</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swordhell.github.io/2024/01/16/prometheus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Abel Sean">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Abel'Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          prometheus
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-01-16 00:00:00" itemprop="dateCreated datePublished" datetime="2024-01-16T00:00:00+08:00">2024-01-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-28 08:17:22" itemprop="dateModified" datetime="2024-03-28T08:17:22+08:00">2024-03-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/3-%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">3-其他</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/3-%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Prometheus：负责采集和存储监控数据，支持多维度查询和告警规则。</p>
<p>Grafana：提供数据可视化和仪表板功能，与多种数据源集成，用于创建自定义监控视图。</p>
<p>Alertmanager：处理来自 Prometheus 的告警通知，执行用户定义的操作，帮助及时响应和解决异常情况。</p>
<span id="more"></span>
<h2 id="通过-docker-compose-部署"><a href="#通过-docker-compose-部署" class="headerlink" title="通过 docker compose 部署"></a>通过 docker compose 部署</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="总配置文件"><a href="#总配置文件" class="headerlink" title="总配置文件"></a>总配置文件</h4><p>./docker-compose.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/prometheus</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus:/etc/prometheus</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;9090:9090&#x27;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prom</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">grafana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">grafana/grafana:10.2.0</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./grafana:/etc/grafana</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GF_SECURITY_ADMIN_PASSWORD=admin</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;3000:3000&#x27;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prom</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">alertmanager:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/alertmanager</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./alertmanager:/etc/alertmanager</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--config.file=/etc/alertmanager/alertmanager.yml&#x27;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;9093:9093&#x27;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prom</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">node_exporter:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node_exporter</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/node-exporter:latest</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;--path.rootfs=/host&#x27;</span></span><br><span class="line">    <span class="attr">pid:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:9100:9100</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/:/host:ro,rslave&#x27;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prom</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">prom:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>
<h4 id="prometheus-配置文件"><a href="#prometheus-配置文件" class="headerlink" title="prometheus 配置文件"></a>prometheus 配置文件</h4><p>./prometheus/prometheus.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;node-1&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;your-ip:your-port&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">&#x27;node&#x27;</span></span><br><span class="line">          <span class="attr">instance:</span> <span class="string">node-1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="报警系统配置文件"><a href="#报警系统配置文件" class="headerlink" title="报警系统配置文件"></a>报警系统配置文件</h3><p>./alertmanager/alertmanager.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span> [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="comment"># 重复的信息，cd时间</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">12h</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">&quot;telegram&quot;</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;telegram&#x27;</span></span><br><span class="line">    <span class="attr">telegram_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">api_url:</span> <span class="string">https://api.telegram.org</span></span><br><span class="line">      <span class="attr">bot_token:</span> <span class="string">&#x27;&lt;你的电报token&gt;&#x27;</span></span><br><span class="line">      <span class="attr">chat_id:</span> <span class="string">&lt;发送到的群组&gt;</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">    <span class="attr">target_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">    <span class="attr">equal:</span> [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;dev&#x27;</span>, <span class="string">&#x27;instance&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>./grafana/grafana.ini</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[server]</span></span><br><span class="line"><span class="attr">http_port</span> = <span class="number">3000</span></span><br></pre></td></tr></table></figure>
<h3 id="新建docker"><a href="#新建docker" class="headerlink" title="新建docker"></a>新建docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d </span><br></pre></td></tr></table></figure>
<h2 id="配置-nginx"><a href="#配置-nginx" class="headerlink" title="配置 nginx"></a>配置 nginx</h2><p>遇到过的问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">transport_websocket.js:32  WebSocket connection to &#x27;wss://xxxx.io/api/live/ws&#x27; failed:</span><br><span class="line">Login failed origin not allowed.</span><br><span class="line">这里需要将nginx的配置检查一下</span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       443 ssl<span class="comment">;</span></span><br><span class="line">        listen       <span class="section">[::]</span>:443 ssl<span class="comment">;</span></span><br><span class="line">        server_name  host-name<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        ssl_certificate &quot;/usr/local/nginx/conf/ssl/xxxx.pem&quot;<span class="comment">;</span></span><br><span class="line">        ssl_certificate_key &quot;/usr/local/nginx/conf/ssl/xxxx.key&quot;<span class="comment">;</span></span><br><span class="line">        ssl_session_cache shared:SSL:1m<span class="comment">;</span></span><br><span class="line">        ssl_session_timeout  10m<span class="comment">;</span></span><br><span class="line">        ssl_ciphers HIGH:!aNULL:!MD5<span class="comment">;</span></span><br><span class="line">        ssl_prefer_server_ciphers on<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        client_max_body_size 500m<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass http://grafana_backend<span class="comment">;</span></span><br><span class="line">                <span class="comment"># 添加以下头部，允许所有来源的请求</span></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;<span class="comment">;</span></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;<span class="comment">;</span></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Origin, X-Requested-With, Content-Type, Accept&#x27;<span class="comment">;</span></span><br><span class="line">                add_header &#x27;Access-Control-Allow-Credentials&#x27; &#x27;true&#x27;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># 下面这样的配置才能支持websocket，</span></span><br><span class="line">                proxy_http_version 1.1<span class="comment">;</span></span><br><span class="line">                proxy_set_header Upgrade $http_upgrade<span class="comment">;</span></span><br><span class="line">                proxy_set_header Connection &quot;upgrade&quot;<span class="comment">;</span></span><br><span class="line">                proxy_set_header Host $host<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">                proxy_read_timeout 86400<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html<span class="comment">;</span></span><br><span class="line">        <span class="attr">location</span> = /<span class="number">40</span>x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html<span class="comment">;</span></span><br><span class="line">        <span class="attr">location</span> = /<span class="number">50</span>x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        access_log /data/wwwlogs/xxx.access.log<span class="comment">;</span></span><br><span class="line">        error_log /data/wwwlogs/xxx.error.log<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream grafana_backend &#123;</span><br><span class="line">        server 127.0.0.1:13000<span class="comment">;</span></span><br><span class="line">        <span class="comment"># 如果有多个后端服务器，可以添加多个 server 指令</span></span><br><span class="line">        <span class="comment"># server grafana_server_ip2:grafana_server_port2;</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="对接监控"><a href="#对接监控" class="headerlink" title="对接监控"></a>对接监控</h2><h3 id="抓取逻辑"><a href="#抓取逻辑" class="headerlink" title="抓取逻辑"></a>抓取逻辑</h3><p>prometheus需要配置监控对象，只有就会主动去抓取数据。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;node-1&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;your-ip:your-port&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">&#x27;node&#x27;</span></span><br><span class="line">          <span class="attr">instance:</span> <span class="string">node-1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里面可以定义抓取的间隔时间。抓取的对象的连接地址，实例编号。</p>
<p>targets里面只能配置一个ip，端口，所以如果地址有些异样，需要自己想办法将其变成根目录的。下面这个例子就是通过nginx转发的实例。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 9300<span class="comment">;</span></span><br><span class="line">    server_name localhost<span class="comment">;</span></span><br><span class="line">    location /metrics &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:9301/debug/metrics/prometheus<span class="comment">;</span></span><br><span class="line">        proxy_set_header Host $host<span class="comment">;</span></span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr<span class="comment">;</span></span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置prometheus-grafana"><a href="#配置prometheus-grafana" class="headerlink" title="配置prometheus+grafana"></a>配置prometheus+grafana</h3><p>配置连接到proemtheus数据源的时候，直接使用docker名称就好了。</p>
<p><a target="_blank" rel="noopener" href="http://prometheus:9090">http://prometheus:9090</a></p>
<p>这个地方无需去看docker inspire里面的ip地址。</p>
<h3 id="配置altermanager"><a href="#配置altermanager" class="headerlink" title="配置altermanager"></a>配置altermanager</h3><h4 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h4><ol>
<li>配置全套prometheus+grafana+alertmanager；</li>
<li>prometheus配置了关注node_experter down的警告；</li>
<li>prometheus配置了推送给alertmanager；</li>
<li>alertmanager配置了通过telegram通知；</li>
</ol>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p><img src="/2024/01/16/prometheus/prometheus-alerts.jpg" alt="prometheus-alerts"></p>
<div style="text-align:center">
prometheus-alerts
</div>

<p><img src="/2024/01/16/prometheus/alertmanager.jpg" alt="alertmanager"></p>
<div style="text-align:center">
alertmanager
</div>

<h4 id="如何配置"><a href="#如何配置" class="headerlink" title="如何配置"></a>如何配置</h4><h5 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h5><p>由于我们这套是通过 docker compose 直接部署的，所以这些服务器都在同一个虚拟局域网中。这里配置 targets 的时候，只需要使用名称。这个信息能从这个docker 的 </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">alertmanager:9093</span></span><br><span class="line"><span class="comment"># 配置自己的警报文件</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;/home/rules/*.yml&quot;</span></span><br></pre></td></tr></table></figure>
<p>警报文件，可能今后需要经常编写这个文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">NodeExporterDown</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Node Exporter is down&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;Node Exporter on <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> is down. Please investigate.&quot;</span></span><br></pre></td></tr></table></figure>
<p>网站探针崩溃的检测程序。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">WebsiteProbeFailed</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">probe_success</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1h</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Website probe failed (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;The Blackbox Exporter probe failed to reach the website <span class="template-variable">&#123;&#123; $labels.target &#125;&#125;</span>&quot;</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<h5 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h5><ol>
<li><p>group_wait: 30s：这个配置定义了在分组期间等待警报的时间。当一个警报被触发后，Alertmanager 会等待一段时间（在这个示例中为 30 秒），以便将其他与之相关的警报（具有相同 group_by 标签的警报）归类到同一个组中。如果在此等待时间内没有其他相关的警报，则立即进行下一步处理。</p>
</li>
<li><p>group_interval: 5m：这个配置定义了在发送警报通知之前，对每个警报组进行等待的时间。在这个示例中，Alertmanager 将等待 5 分钟，以便将同一组中的所有警报聚合起来，并一次性发送一个通知，而不是为每个警报分别发送通知。</p>
</li>
<li><p>repeat_interval: 1h：这个配置定义了重复发送警报通知的时间间隔。在这个示例中，Alertmanager 将在每个警报组的第一次发送通知之后，每隔 1 小时重复发送一次通知，直到该组中的所有警报被解决。</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span> [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span> <span class="comment"># 在分组后，等待 30 秒，以便将相关的报警聚合到同一通知中。</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span> <span class="comment"># 在发送一次通知后，等待 5 分钟再发送下一次相同分组的通知。</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">1h</span> <span class="comment"># 在发送通知后，等待 1 小时再次发送相同分组的通知。</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">&quot;telegram&quot;</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;telegram&#x27;</span></span><br><span class="line">    <span class="attr">telegram_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">api_url:</span> <span class="string">https://api.telegram.org</span></span><br><span class="line">      <span class="attr">bot_token:</span> <span class="string">&#x27;&lt;机器人-token&gt;&#x27;</span></span><br><span class="line">      <span class="attr">chat_id:</span> <span class="string">&lt;聊天群编号/个人编号&gt;</span></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span> <span class="comment"># 匹配满足某些条件的源报警。</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;critical&#x27;</span> <span class="comment"># 匹配严重性为 &#x27;critical&#x27; 的报警。</span></span><br><span class="line">    <span class="attr">target_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">    <span class="attr">equal:</span> [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;dev&#x27;</span>, <span class="string">&#x27;instance&#x27;</span>]</span><br></pre></td></tr></table></figure>
<h4 id="发现的问题"><a href="#发现的问题" class="headerlink" title="发现的问题"></a>发现的问题</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ts=2024-01-25T01:37:17.880Z caller=notify.go:745 level=warn component=dispatcher receiver=telegram integration=telegram[0] aggrGroup=&quot;&#123;&#125;:&#123;alertname=\&quot;NodeExporterDown\&quot;&#125;&quot; msg=&quot;Notify attempt failed, will retry later&quot; attempts=1 err=&quot;telegram: chat not found (400)&quot;</span><br><span class="line">ts=2024-01-25T01:42:16.210Z caller=dispatch.go:352 level=error component=dispatcher msg=&quot;Notify for alerts failed&quot; num_alerts=1 err=&quot;telegram/telegram[0]: notify retry canceled after 16 attempts: telegram: chat not found (400)&quot;</span><br><span class="line">ts=2024-01-25T01:42:16.536Z caller=notify.go:745 level=warn component=dispatcher receiver=telegram integration=telegram[0] aggrGroup=&quot;&#123;&#125;:&#123;alertname=\&quot;NodeExporterDown\&quot;&#125;&quot; msg=&quot;Notify attempt failed, will retry later&quot; attempts=1 err=&quot;telegram: chat not found (400)&quot;</span><br></pre></td></tr></table></figure>
<p>这个问题过了一段时间之后又好起来了。应该问题还是来自于没有将 prometheus 里面的警报规则配置好造成的。</p>
<h5 id="报警出来的内容"><a href="#报警出来的内容" class="headerlink" title="报警出来的内容"></a>报警出来的内容</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Alerts Resolved:</span><br><span class="line">Labels:</span><br><span class="line"> - alertname = NodeExporterDown</span><br><span class="line"> - instance = 开发机</span><br><span class="line"> - job = 开发</span><br><span class="line">Annotations:</span><br><span class="line"> - description = Node Exporter on 开发机 is down. Please investigate.</span><br><span class="line"> - summary = Node Exporter is down</span><br><span class="line">Source: </span><br></pre></td></tr></table></figure>
<h4 id="分段时间来实现警报"><a href="#分段时间来实现警报" class="headerlink" title="分段时间来实现警报"></a>分段时间来实现警报</h4><p>要实现在晚上减少警报频率，白天增加警报积极性的功能，你可以使用 Prometheus 的告警路由（Alert Routing）和告警控制器（Alertmanager）来实现。下面是一种可能的实现方法：</p>
<ol>
<li>定义两组警报规则：</li>
</ol>
<p>一组规则用于在白天触发警报，可以更积极地监控系统状态。<br>另一组规则用于在晚上触发警报，可以减少频率或者延迟警报发送。</p>
<ol>
<li>配置告警路由：</li>
</ol>
<p>使用 Prometheus 的告警路由配置文件，定义不同时间段的警报路由策略。在白天，配置策略以更积极的方式处理警报（例如立即发送通知），而在晚上，配置策略以减少频率或延迟发送通知。</p>
<ol>
<li>配置告警控制器：</li>
</ol>
<p>在 Alertmanager 的配置文件中，定义两个接收者配置。一个接收者用于白天发送警报通知，另一个接收者用于晚上发送警报通知。根据定义的告警路由策略，Alertmanager 将根据时间段选择适当的接收者来处理警报。</p>
<ol>
<li>定义警报规则时间条件：</li>
</ol>
<p>在定义警报规则时，考虑添加时间条件，以便只在特定时间段触发警报。你可以使用 Prometheus 的 time() 函数来指定时间条件。</p>
<p>下面是一个简单的示例配置，仅用于说明概念：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Prometheus Alert Rules</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">daytime.rules</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighRequestLatency</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">request_latency_seconds</span> <span class="string">&gt;</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;High request latency detected&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;The average request latency is above 1s.&quot;</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">6h-18h</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nighttime.rules</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighRequestLatency</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">request_latency_seconds</span> <span class="string">&gt;</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;High request latency detected&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;The average request latency is above 1s.&quot;</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">18h-6h</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><br>在这个示例中：</p>
<p>daytime.rules 组定义了白天的警报规则，仅在早上 6 点到晚上 6 点之间触发。<br>nighttime.rules 组定义了晚上的警报规则，仅在晚上 6 点到早上 6 点之间触发。<br>然后，根据你的实际需求和部署情况，配置 Alertmanager 来根据定义的时间条件选择适当的接收者，并根据需求调整警报触发策略和通知频率。</p>
<h4 id="PromQL-ChatGPT"><a href="#PromQL-ChatGPT" class="headerlink" title="PromQL-ChatGPT"></a>PromQL-ChatGPT</h4><p>当然，我可以为你提供一个从基础到逐渐复杂的 Prometheus PromQL 学习梯度。PromQL 是 Prometheus 查询语言，用于从 Prometheus 时间序列数据库中提取和分析数据。</p>
<h3 id="1-基础概念："><a href="#1-基础概念：" class="headerlink" title="1. 基础概念："></a>1. 基础概念：</h3><p><strong>Metric（度量标准）：</strong></p>
<ul>
<li>Prometheus 收集的数据的基本单位。</li>
<li>例子：<code>http_requests_total</code>，表示HTTP请求数量。</li>
</ul>
<p><strong>Selector（选择器）：</strong></p>
<ul>
<li>通过标签（key-value对）来筛选数据。</li>
<li>例子：<code>http_requests_total&#123;job=&quot;api-server&quot;, method=&quot;GET&quot;&#125;</code>，选择 API 服务器上的 GET 请求。</li>
</ul>
<h3 id="2-基本操作："><a href="#2-基本操作：" class="headerlink" title="2. 基本操作："></a>2. 基本操作：</h3><p><strong>基本查看：</strong></p>
<ul>
<li>查询所有指标：<code>up</code>。</li>
<li>查询特定指标：<code>http_requests_total</code>。</li>
</ul>
<p><strong>时间范围：</strong></p>
<ul>
<li>默认时间范围是最近5分钟。</li>
<li>指定时间范围：<code>http_requests_total&#123;job=&quot;api-server&quot;&#125;[1h]</code>，表示过去1小时的数据。</li>
</ul>
<h3 id="3-聚合和函数："><a href="#3-聚合和函数：" class="headerlink" title="3. 聚合和函数："></a>3. 聚合和函数：</h3><p><strong>聚合操作：</strong></p>
<ul>
<li><code>sum()</code>：求和。</li>
<li><code>avg()</code>：求平均。</li>
<li>例子：<code>sum(http_requests_total)</code>，表示所有实例的请求数之和。</li>
</ul>
<p><strong>函数：</strong></p>
<ul>
<li><code>rate()</code>：计算速率。</li>
<li><code>increase()</code>：计算增长量。</li>
<li>例子：<code>rate(http_requests_total[5m])</code>，表示过去5分钟的请求速率。</li>
</ul>
<h3 id="4-进阶操作："><a href="#4-进阶操作：" class="headerlink" title="4. 进阶操作："></a>4. 进阶操作：</h3><p><strong>多维数据操作：</strong></p>
<ul>
<li>使用 <code>group by</code> 对结果进行分组。</li>
<li>例子：<code>sum(http_requests_total) by (job)</code>，表示按作业（job）对请求数进行求和。</li>
</ul>
<p><strong>条件和比较：</strong></p>
<ul>
<li>使用 <code>if</code> 和 <code>==</code> 等条件操作符。</li>
<li>例子：<code>http_requests_total &gt; 100</code>，表示请求数量大于100的情况。</li>
</ul>
<h3 id="5-子查询和子表达式："><a href="#5-子查询和子表达式：" class="headerlink" title="5. 子查询和子表达式："></a>5. 子查询和子表达式：</h3><p><strong>子查询：</strong></p>
<ul>
<li>使用子查询可以嵌套一个查询到另一个查询中。</li>
<li>例子：<code>(sum(rate(http_requests_total[5m])) / 100) * 60</code>，表示每分钟请求数超过100的百分比。</li>
</ul>
<p><strong>子表达式：</strong></p>
<ul>
<li>使用括号来组合表达式。</li>
<li>例子：<code>http_requests_total * (1 - error_rate)</code>，表示请求总数减去错误率。</li>
</ul>
<h3 id="6-函数式编程："><a href="#6-函数式编程：" class="headerlink" title="6. 函数式编程："></a>6. 函数式编程：</h3><p><strong>使用 <code>label_replace</code> 函数：</strong></p>
<ul>
<li>用于修改标签。</li>
<li>例子：<code>label_replace(http_requests_total, &quot;status&quot;, &quot;2xx&quot;, &quot;&quot;, &quot;(.*)&quot; == &quot;2.*&quot;)</code>，将 status 标签中以 “2” 开头的值替换为 “2xx”。</li>
</ul>
<p><strong>使用 <code>absent</code> 函数：</strong></p>
<ul>
<li>用于查找缺失的时间序列。</li>
<li>例子：<code>absent(http_requests_total)</code>，查找缺少 http_requests_total 时间序列的实例。</li>
</ul>
<p>这是一个逐渐增加难度的学习路径，你可以根据需要深入研究每个主题。PromQL 是一个非常强大和灵活的查询语言，对于监控和分析系统性能非常有帮助。</p>
<h3 id="golang-gin-添加-Prometheus"><a href="#golang-gin-添加-Prometheus" class="headerlink" title="golang gin 添加  Prometheus"></a>golang gin 添加  Prometheus</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/gin-contrib/prometheus&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/prometheus/client_golang/prometheus/promhttp&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用 gin-contrib/prometheus 中间件</span></span><br><span class="line">	p := prometheus.NewPrometheus(<span class="string">&quot;gin&quot;</span>)</span><br><span class="line">	p.Use(r)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加路由</span></span><br><span class="line">	r.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.JSON(<span class="number">200</span>, gin.H&#123;</span><br><span class="line">			<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello, Prometheus!&quot;</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加 /metrics 路由，用于 Prometheus 收集</span></span><br><span class="line">	r.GET(<span class="string">&quot;/metrics&quot;</span>, gin.WrapH(promhttp.Handler()))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 启动服务器</span></span><br><span class="line">	r.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/2024/01/16/prometheus/blackbox_exporter.jpg" alt="Prometheus 监控网站证书是否过期"></p>
<p>要使用 Prometheus 监控网站证书是否过期，你可以使用 <code>blackbox_exporter</code>，这是 Prometheus 的一种 exporter，专门用于执行对端（例如 HTTP、HTTPS）的探测。以下是基本的步骤：</p>
<ol>
<li><p><strong>使用docker-compose安装： <code>blackbox_exporter</code>：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">blackbox-exporter:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">prom/blackbox-exporter</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9115:9115&quot;</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">prom</span></span><br></pre></td></tr></table></figure>
<p>在这个例子中，我们定义了一个探测模块，它使用 HTTP GET 请求检测一个网站（<code>example.com</code>）的证书是否过期。你可以根据需要调整配置。</p>
</li>
<li><p><strong>配置 Prometheus：</strong></p>
<p>将 <code>blackbox_exporter</code> 添加到 Prometheus 的配置文件中。以下是一个简单的示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox&#x27;</span> </span><br><span class="line"> <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line"> <span class="attr">params:</span> </span><br><span class="line">   <span class="attr">module:</span> [<span class="string">http_2xx</span>] </span><br><span class="line"> <span class="attr">static_configs:</span> </span><br><span class="line">   <span class="bullet">-</span> <span class="attr">targets:</span> </span><br><span class="line">     <span class="comment">#需要监控SSL的域名</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">https://www.baidu.com</span></span><br><span class="line"> <span class="attr">relabel_configs:</span> </span><br><span class="line">   <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">     <span class="attr">target_label:</span> <span class="string">__param_target</span> </span><br><span class="line">   <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">     <span class="attr">target_label:</span> <span class="string">instance</span> </span><br><span class="line">   <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span> </span><br><span class="line">     <span class="attr">replacement:</span> <span class="string">blackbox-exporter:9115</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">WebsiteProbeFailed</span></span><br><span class="line">    <span class="attr">expr:</span> <span class="string">probe_success</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">summary:</span> <span class="string">&quot;Website probe failed (instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>)&quot;</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">&quot;The Blackbox Exporter probe failed to reach the website <span class="template-variable">&#123;&#123; $labels.target &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>   在这个例子中，我们配置了一个 <code>blackbox</code> 作业，告诉 Prometheus 去 <code>/probe</code> 路径下检测 <code>http_2xx</code> 模块。</p>
<ol>
<li><p><strong>重新启动 Prometheus：</strong></p>
<p>重启 Prometheus 以应用新的配置。</p>
</li>
<li><p><strong>查看监控数据：</strong></p>
<p>在 Prometheus 的 Web UI 或 Grafana 等监控工具中查看证书过期的监控数据。你可以使用 Prometheus 查询语言（PromQL）来创建仪表板或警报规则。</p>
</li>
</ol>
<p>请注意，上述步骤中的配置仅供参考，你需要根据你的具体需求和网络环境进行适当调整。此外，为了避免在生产环境中使用 <code>insecure_skip_verify: true</code>，你应该配置证书验证来提高安全性。<br>在 Docker Compose 中部署 <code>blackbox_exporter</code>，你可以使用一个简单的 Docker Compose 文件来定义 <code>blackbox_exporter</code> 服务。以下是一个基本的示例：</p>
<ol>
<li><p><strong>创建 Docker Compose 文件（<code>docker-compose.yml</code>）：</strong></p>
<p>创建一个文件，例如 <code>docker-compose.yml</code>，并添加以下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">blackbox-exporter:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/blackbox-exporter</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9115:9115&quot;</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;--config.file=/etc/blackbox_exporter/config.yml&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/blackbox_exporter/config.yml</span></span><br></pre></td></tr></table></figure>
<p>在这个示例中，我们使用 <code>prom/blackbox-exporter</code> 镜像，将容器的 <code>9115</code> 端口映射到主机的 <code>9115</code> 端口上，并将配置文件 <code>config.yml</code> 挂载到容器的 <code>/etc/blackbox_exporter/</code> 目录下。</p>
</li>
<li><p><strong>创建 Blackbox Exporter 配置文件（<code>config.yml</code>）：</strong></p>
<p>在与 <code>docker-compose.yml</code> 同级的目录下创建 <code>config.yml</code> 文件，用于配置 <code>blackbox_exporter</code>。以下是一个简单的示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">http_2xx:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">insecure_skip_verify:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>这个示例与之前提到的 <code>blackbox.yml</code> 类似。</p>
</li>
<li><p><strong>运行 Docker Compose：</strong></p>
<p>在包含 <code>docker-compose.yml</code> 的目录中执行以下命令启动 <code>blackbox_exporter</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<p><code>-d</code> 标志表示在后台运行。</p>
</li>
<li><p><strong>查看监控数据：</strong></p>
<p>访问 <code>http://localhost:9115/metrics</code>，你应该能够看到 <code>blackbox_exporter</code> 的监控数据。你也可以将 <code>blackbox-exporter</code> 集成到 Prometheus 中，并在 Grafana 或其他监控工具中查看数据。</p>
</li>
</ol>
<p>确保你的主机上已经安装了 Docker 和 Docker Compose。此外，根据需要，可以调整配置文件和 <code>docker-compose.yml</code> 文件以适应你的环境和需求。</p>
<h3 id="prometheus和springboot版本不匹配"><a href="#prometheus和springboot版本不匹配" class="headerlink" title="prometheus和springboot版本不匹配"></a>prometheus和springboot版本不匹配</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">springboot 3.1.4</span><br><span class="line">prom/prometheus:v2.42.0</span><br><span class="line">grafana/grafana:8.5.27</span><br><span class="line">错了版本之后，将会有406版本。</span><br></pre></td></tr></table></figure>
<p><img src="/2024/01/16/prometheus/prometheus-spring-boot.jpg" alt><br><img src="/2024/01/16/prometheus/prometheus-vrsion.jpg" alt></p>
<h3 id="常用的-dashboard"><a href="#常用的-dashboard" class="headerlink" title="常用的 dashboard"></a>常用的 dashboard</h3><p><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/11074-node-exporter-for-prometheus-dashboard-en-v20201010/">https://grafana.com/grafana/dashboards/11074-node-exporter-for-prometheus-dashboard-en-v20201010/</a></p>
<p><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/13659-blackbox-exporter-http-prober/">https://grafana.com/grafana/dashboards/13659-blackbox-exporter-http-prober/</a></p>
<p><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/4701-jvm-micrometer/">https://grafana.com/grafana/dashboards/4701-jvm-micrometer/</a></p>
<p><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/1860-node-exporter-full/">https://grafana.com/grafana/dashboards/1860-node-exporter-full/</a></p>
<p><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/4701-jvm-micrometer/">https://grafana.com/grafana/dashboards/4701-jvm-micrometer/</a></p>
<p><a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/11378-justai-system-monitor/">https://grafana.com/grafana/dashboards/11378-justai-system-monitor/</a></p>
<h2 id="blackbox-exporter"><a href="#blackbox-exporter" class="headerlink" title="blackbox_exporter"></a>blackbox_exporter</h2><p>在Prometheus中监控一个健康接口，通常使用 <code>probe</code> 类型的 <code>blackbox_exporter</code>，这个 exporter 可以通过 HTTP、TCP、ICMP 等方式进行健康检查。</p>
<p>以下是如何配置 <code>blackbox_exporter</code> 来监控一个健康接口的示例：</p>
<ol>
<li><p><strong>下载并安装 <code>blackbox_exporter</code>：</strong></p>
<p>你可以从 <a target="_blank" rel="noopener" href="https://github.com/prometheus/blackbox_exporter/releases">blackbox_exporter 的 GitHub Releases 页面</a> 下载二进制文件，并将其放置在你的系统上。</p>
</li>
<li><p><strong>创建 <code>blackbox.yml</code> 配置文件：</strong></p>
<p>在同一目录下创建一个名为 <code>blackbox.yml</code> 的配置文件，用于定义健康检查的目标。以下是一个示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">http_healthy:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">valid_http_versions:</span> [<span class="string">&quot;HTTP/1.1&quot;</span>, <span class="string">&quot;HTTP/2&quot;</span>]</span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">Host:</span> <span class="string">&quot;example.com&quot;</span></span><br><span class="line">      <span class="attr">fail_if_ssl:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">fail_if_not_ssl:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">fail_if_body_not_matches_regexp:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;OK&quot;</span></span><br><span class="line">      <span class="attr">fail_if_header_not_matches_regexp:</span></span><br><span class="line">        <span class="attr">&quot;Content-Type&quot;:</span> [<span class="string">&quot;text/html; charset=utf-8&quot;</span>]</span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure>
<p>在这个示例中，我们定义了一个名为 <code>http_healthy</code> 的模块，使用 HTTP 探测器 (<code>prober: http</code>)，检查目标是否返回 HTTP 状态码 200、包含 “OK” 文本，并且 <code>Content-Type</code> 是 “text/html; charset=utf-8”。</p>
</li>
<li><p><strong>运行 <code>blackbox_exporter</code>：</strong></p>
<p>使用以下命令运行 <code>blackbox_exporter</code>，指定配置文件路径：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./blackbox_exporter --config.file=blackbox.yml</span><br></pre></td></tr></table></figure>
<p>请根据你的操作系统和二进制文件的位置进行相应的调整。</p>
</li>
<li><p><strong>配置 Prometheus 抓取规则：</strong></p>
<p>在 Prometheus 的配置文件中添加以下内容，以定期抓取 <code>blackbox_exporter</code> 的结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox&#x27;</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">module:</span> [<span class="string">http_healthy</span>]</span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">http://example.com/health</span></span><br></pre></td></tr></table></figure>
<p>在这个示例中，我们定义了一个 <code>blackbox</code> 作业，配置了 <code>blackbox_exporter</code> 的 URL 和 <code>blackbox.yml</code> 中定义的模块。</p>
</li>
<li><p><strong>重新加载 Prometheus 配置：</strong></p>
<p>重新加载 Prometheus 的配置，以使其读取新的抓取规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -HUP &lt;prometheus_pid&gt;</span><br></pre></td></tr></table></figure>
<p>替换 <code>&lt;prometheus_pid&gt;</code> 为运行 Prometheus 的进程 ID。</p>
</li>
</ol>
<p>现在，Prometheus 将定期抓取 <code>blackbox_exporter</code> 的结果，并将其作为监控指标存储在 Prometheus 中。你可以通过查询和仪表板来检查该健康检查的状态。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul>
<li>[1] <a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/">grafana-dashboards</a></li>
<li>[2] <a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/11074-node-exporter-for-prometheus-dashboard-en-v20201010/">prometheus-node-exporter</a></li>
<li>[3] <a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/latest/configuration/#telegram_config">altermanager-配置telegram方式</a></li>
<li>[4] <a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/basics/">prometheus-PromQL-文档</a></li>
<li>[5] <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1wE411E76N/?spm_id_from=333.337.search-card.all.click&amp;vd_source=19029f488c3528e0779a0e81bfdecf30">b站-入门PromQL</a></li>
<li>[6] <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1up4y1C7xE/?vd_source=19029f488c3528e0779a0e81bfdecf30">b站-境界PromQL</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%BF%90%E7%BB%B4/" rel="tag"># 运维</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/01/12/Elastic-Kibana/" rel="prev" title="Elastic-Kibanna">
      <i class="fa fa-chevron-left"></i> Elastic-Kibanna
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/01/25/swag/" rel="next" title="swag">
      swag <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-docker-compose-%E9%83%A8%E7%BD%B2"><span class="nav-number">1.1.</span> <span class="nav-text">通过 docker compose 部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.1.1.</span> <span class="nav-text">配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">总配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#prometheus-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">prometheus 配置文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E8%AD%A6%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">1.1.2.</span> <span class="nav-text">报警系统配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%BB%BAdocker"><span class="nav-number">1.1.3.</span> <span class="nav-text">新建docker</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-nginx"><span class="nav-number">1.2.</span> <span class="nav-text">配置 nginx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E6%8E%A5%E7%9B%91%E6%8E%A7"><span class="nav-number">1.3.</span> <span class="nav-text">对接监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%93%E5%8F%96%E9%80%BB%E8%BE%91"><span class="nav-number">1.3.1.</span> <span class="nav-text">抓取逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEprometheus-grafana"><span class="nav-number">1.3.2.</span> <span class="nav-text">配置prometheus+grafana</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEaltermanager"><span class="nav-number">1.3.3.</span> <span class="nav-text">配置altermanager</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%88%E6%9E%9C%E5%9B%BE"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">效果图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">如何配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#prometheus"><span class="nav-number">1.3.3.3.1.</span> <span class="nav-text">prometheus</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#alertmanager"><span class="nav-number">1.3.3.3.2.</span> <span class="nav-text">alertmanager</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.3.4.</span> <span class="nav-text">发现的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8A%A5%E8%AD%A6%E5%87%BA%E6%9D%A5%E7%9A%84%E5%86%85%E5%AE%B9"><span class="nav-number">1.3.3.4.1.</span> <span class="nav-text">报警出来的内容</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%AE%B5%E6%97%B6%E9%97%B4%E6%9D%A5%E5%AE%9E%E7%8E%B0%E8%AD%A6%E6%8A%A5"><span class="nav-number">1.3.3.5.</span> <span class="nav-text">分段时间来实现警报</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PromQL-ChatGPT"><span class="nav-number">1.3.3.6.</span> <span class="nav-text">PromQL-ChatGPT</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%EF%BC%9A"><span class="nav-number">1.3.4.</span> <span class="nav-text">1. 基础概念：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="nav-number">1.3.5.</span> <span class="nav-text">2. 基本操作：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%81%9A%E5%90%88%E5%92%8C%E5%87%BD%E6%95%B0%EF%BC%9A"><span class="nav-number">1.3.6.</span> <span class="nav-text">3. 聚合和函数：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%BF%9B%E9%98%B6%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="nav-number">1.3.7.</span> <span class="nav-text">4. 进阶操作：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%AD%90%E6%9F%A5%E8%AF%A2%E5%92%8C%E5%AD%90%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%9A"><span class="nav-number">1.3.8.</span> <span class="nav-text">5. 子查询和子表达式：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%EF%BC%9A"><span class="nav-number">1.3.9.</span> <span class="nav-text">6. 函数式编程：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#golang-gin-%E6%B7%BB%E5%8A%A0-Prometheus"><span class="nav-number">1.3.10.</span> <span class="nav-text">golang gin 添加  Prometheus</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#prometheus%E5%92%8Cspringboot%E7%89%88%E6%9C%AC%E4%B8%8D%E5%8C%B9%E9%85%8D"><span class="nav-number">1.3.11.</span> <span class="nav-text">prometheus和springboot版本不匹配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84-dashboard"><span class="nav-number">1.3.12.</span> <span class="nav-text">常用的 dashboard</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#blackbox-exporter"><span class="nav-number">1.4.</span> <span class="nav-text">blackbox_exporter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E7%94%A8"><span class="nav-number">1.5.</span> <span class="nav-text">引用</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Abel Sean"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Abel Sean</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://blog.csdn.net/erlang_hell" title="http:&#x2F;&#x2F;blog.csdn.net&#x2F;erlang_hell" rel="noopener" target="_blank">我的csdn-blog</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://dengwenyi88.github.io/" title="https:&#x2F;&#x2F;dengwenyi88.github.io&#x2F;" rel="noopener" target="_blank">dwy-blog</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://unity3d.io/" title="https:&#x2F;&#x2F;unity3d.io" rel="noopener" target="_blank">蔡总-blog</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Abel Sean</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'b08c5201a4a52badc863',
      clientSecret: 'dd2c48988eb499969198746dae8ec2c7ccbad00b',
      repo        : 'BlogComment',
      owner       : 'swordhell',
      admin       : ['swordhell'],
      id          : 'ce22c4abffa4ad6d4a55ab52fa458938',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
